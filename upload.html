<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
</head>

<!-- Bootstrap -->
<!-- Latest compiled and minified CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>



<body>
    <div class="container">
        <div class="row text-center">
            User Information
        </div>

        
        <!-- <div class="input-group mb-3">
            <div class="input-group-append">
                <span class="input-group-text" >Email</span>
            </div>
            <input type="text" class="form-control" placeholder="Email" id='email'>

        </div>
        <div class="input-group mb-3">
            <div class="input-group-append">
                <span class="input-group-text" >Pasword</span>
            </div>
            <input type="text" class="form-control" placeholder="Password" id='password'>
        </div>
         -->
        
        <div class="input-group mb-3">
            <div class="input-group-append">
                <span class="input-group-text" >FileName</span>
            </div>
            <div>
                <label id='extlab'></label>
            </div>
            <input type="text" class="form-control" placeholder="File Name" id='fileName'>
        </div>
         <div class="progress">
                <div class="progress-bar" role="progressbar" id="pbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
<hr>    
        <div class="input-group mb-3">
            <input type="file" class="form-control" id='file'>
        </div>
                <audio controls autoplay muted>
            <source id='music' src="https://firebasestorage.googleapis.com/v0/b/audiophile-eff2c.appspot.com/o/Music%2FBlackbird.mp3?alt=media&token=a2e6112e-b8cc-413b-ac8c-a0f0791ee9c3" type="audio/mpeg">
        </audio>
        <br>
        <button class='btn btn-warning' id='upload' >Upload</button>
        <button class='btn btn-success' id='retrieve'>Retrieve</button>
    </div>
    

</body>
<!-- Firebase-->
<script type='module'>
    import * as THREE from 'https://cdn.skypack.dev/three@0.133.1';
    import {initializeApp} from "https://www.gstatic.com/firebasejs/9.2.0/firebase-app.js"; //initialize firebase app
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL} from "https://www.gstatic.com/firebasejs/9.2.0/firebase-storage.js" //for firebase storage
    

    const firebaseConfig = {
    apiKey: "AIzaSyDRVQ7r6TGsQhZGvVIXws7y5PTPqlvC2yo",
    authDomain: "audiophile-eff2c.firebaseapp.com",
    databaseURL: "https://audiophile-eff2c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "audiophile-eff2c",
    storageBucket: "audiophile-eff2c.appspot.com",
    messagingSenderId: "141435951049",
    appId: "1:141435951049:web:6308bd4b9fe95fb49bba18",
    measurementId: "G-LKVP0JH4YH"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-auth.js"
  import {getDatabase, ref,set,child,update,remove,get } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-database.js"
  const realdb= getDatabase();
    
let reader = new FileReader(),
files = [];
let nameBox = document.getElementById('fileName'),
    upload = document.getElementById('upload'),
    inputFile = document.getElementById('file'),
    pbar = document.getElementById('pbar'),
    retrieve = document.getElementById('retrieve'),
    music = document.getElementById('music'),
    ext = document.getElementById('extlab')

        console.log(inputFile)
        inputFile.addEventListener('change', function(event){
            files = event.target.files // file selected by user
            console.log()
            var extention = GetFileExt(files[0])
            var name = GetFileName(files[0])
            nameBox.value=name
            extlab.innerHTML = extention; 
            reader.readAsDataURL(files[0])
        })

        reader.onload=function(){
            music.src = reader.result;
        }

    // Selection
    function GetFileExt(file){
        var temp = file.name.split('.');
        var ext = temp.slice(temp.length-1,temp.length);
        return '.'+ext[0]
    }
    function GetFileName(file){
        var temp = file.name.split('.');
        var fname = temp.slice(0,-1).join('.');
        return fname
    }

// Upload Process
async function UploadProcess(){
    var fileToUpload =files[0];
    console.log(fileToUpload)
    var fileToUploadName = nameBox.value +  extlab.innerHTML;
    if(!ValidateName()){
        alert('name cannot wrong')
        return;
    }
    const metaData = {
        contentType: fileToUpload.type
    }

    const storage = getStorage();

    const storageRef =sRef(storage,"Music/"+fileToUploadName);

    const UploadTask = uploadBytesResumable(storageRef,fileToUpload,metaData);

    UploadTask.on('state-changed',(snapshot)=>{
        var progress= (snapshot.bytesTransferred/snapshot.totalBytes) * 100;
        pbar.innerHTML ='Upload' + progress + "%"
        pbar.style.width= progress+"%"
    },

    (error)=>{
        alert("error: File failed to upload");
    },

    ()=>{
        getDownloadURL(UploadTask.snapshot.ref).then((downloadURL)=>{
            SaveURLtoRealTimeDB(downloadURL);
            });
        }
        );
    }

    // Function REALTIME DATABASE
    function SaveURLtoRealTimeDB(URL){
        var name = nameBox.value;
        var ext =extlab.innerHTML
        set(ref(realdb,"MusicFileLinks/") + name),{
            musicName:(name+ext),
            musicURL:URL
        }
    }
    function GetUrlfromRealTimeDB(){
        var name =nameBox.value;
        var dbRef =ref(realdb);
        get(child(dbRef,"MusicFileLinks/"+ name)).then((snapshot)=>{
            if(snapshot.exists()){
                music.src=snapshot.val().musicURL
            }
        })}

    function validateName(){
        var regex=/[\.#$\[]]/
        return !(regex.test(nameBox.value));
    }
    retrieve.onclick=GetUrlfromRealTimeDB;
    upload.onclick=UploadProcess;
</script>
<script>

</script>


<!-- Latest compiled and minified JavaScript -->

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
</html>