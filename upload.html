<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="shortcut icon" href="#">
		<title>My first three.js app</title>
		<!-- Bootstrap CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">


		<style>
			#canvas {
				width: 80%;
				height: 80%;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<ul class="nav nav-tabs justify-content-center">
				<li class="nav-item">
					<a class="nav-link" aria-current="page" href="/">Playlist Visualizer</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#">Spotify Visualizer</a>
				</li>
				<li class="nav-item">
					<a class="nav-link active" href="upload.html">Visualize your audio</a>
				</li>
			</ul>
			<div class="input-group mb-3">
				<input type="file" class="form-control" id="inputAudio" @change="loadAudio" accept="audio/*">
				<label class="input-group-text" for="inputAudio">Upload an audio file</label>
			</div>
			<canvas id="canvas"></canvas>
			<audio controls id="player" :src="music"></audio>
		</div>

        <!-- Three.js library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.js" integrity="sha512-NLtnLBS9Q2w7GKK9rKxdtgL7rA7CAS85uC/0xd9im4J/yOL4F9ZVlv634NAM7run8hz3wI2GabaA6vv8vJtHiQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.1/gsap.min.js" integrity="sha512-UxP+UhJaGRWuMG2YC6LPWYpFQnsSgnor0VUF3BHdD83PS/pOpN+FYbZmrYN+ISX8jnvgVUciqP/fILOXDjZSwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

		<!-- Vue.js -->
		<script src="https://unpkg.com/vue@next"></script>

		<!-- Bootstrap JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>

		<!-- Axios API -->
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

		<!-- 2D Dynamic Visualization Library -->
		<script src="https://cdn.jsdelivr.net/gh/foobar404/wave.js/dist/bundle.iife.js"></script>
		
		<!-- Visualization Scripts (if any) -->
		<!-- <script src="visuals/Boxes.js"></script> -->

		<script>

			const app = Vue.createApp({
				data(){
					return {
						music: ""
					}
				},
				methods: {
					loadAudio(event){
						var audioBlob = URL.createObjectURL(event.target.files[0])
						this.music = audioBlob
						let audio = document.getElementById("player")
						audio.load()
						
						var context = new AudioContext();
						var src = context.createMediaElementSource(audio);
						var analyser = context.createAnalyser();

						var canvas = document.getElementById("canvas");
						canvas.width = window.innerWidth;
						canvas.height = window.innerHeight;
						var ctx = canvas.getContext("2d");

						src.connect(analyser);
						analyser.connect(context.destination);

						analyser.fftSize = 256;

						var bufferLength = analyser.frequencyBinCount;
						console.log(bufferLength);

						var dataArray = new Uint8Array(bufferLength);

						var WIDTH = canvas.width;
						var HEIGHT = canvas.height;

						var barWidth = (WIDTH / bufferLength) * 2.5;
						var barHeight;
						var x = 0;

						function renderFrame() {
						requestAnimationFrame(renderFrame);

						x = 0;

						analyser.getByteFrequencyData(dataArray);

						ctx.fillStyle = "#000";
						ctx.fillRect(0, 0, WIDTH, HEIGHT);

						for (var i = 0; i < bufferLength; i++) {
							barHeight = dataArray[i];
							
							var r = barHeight + (25 * (i/bufferLength));
							var g = 250 * (i/bufferLength);
							var b = 50;

							ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
							ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

							x += barWidth + 1;
						}
						}

						var playPromise = audio.play();

						if (playPromise !== undefined) {
							playPromise.then(_ => {
							// Automatic playback started!
							// Show playing UI.
							})
							.catch(error => {
							// Auto-play was prevented
							// Show paused UI.
							});
						}
						renderFrame();
					}
				}
			})

			const vm = app.mount("#app")
		</script>
		</script>
	</body>
</html>